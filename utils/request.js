"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

exports.__esModule = true;
exports.default = void 0;

var _https = _interopRequireDefault(require("https"));

var _zlib = _interopRequireDefault(require("zlib"));

var _constants = require("../constants");

var _convertValues = require("./convertValues");

function handleBodyResponse(res, body, resolve, reject, logger) {
	try {
		var _JSONObject$error, _JSONObject$errors;

		if (!/application\/json/.test(res.headers["content-type"]) || body.trim() === "") {
			logger.error("The response body from the BigCommerce API is not in JSON format.");
			return resolve(body);
		}

		var JSONObject = (0, _convertValues.handleConversionStringToObject)(body);
		var JSONError = (_JSONObject$error = JSONObject === null || JSONObject === void 0 ? void 0 : JSONObject.error) !== null && _JSONObject$error !== void 0 ? _JSONObject$error : null;
		var JSONErrors = (_JSONObject$errors = JSONObject === null || JSONObject === void 0 ? void 0 : JSONObject.errors) !== null && _JSONObject$errors !== void 0 ? _JSONObject$errors : null;

		if (JSONError !== null || JSONErrors !== null) {
			var err = new Error(JSONError || (0, _convertValues.handleConversionObjectToString)(JSONErrors));
			return reject(err);
		}

		return resolve(JSONObject);
	} catch (err) {
		err.responseBody = body;
		return reject(err);
	}
}

var Request = (function () {
	function Request(hostname, _temp) {
		if (hostname === void 0) {
			hostname = null;
		}

		var _ref = _temp === void 0 ? {} : _temp,
			_ref$headers = _ref.headers,
			headers = _ref$headers === void 0 ? {} : _ref$headers,
			_ref$agent = _ref.agent,
			agent = _ref$agent === void 0 ? null : _ref$agent,
			_ref$logger = _ref.logger,
			logger = _ref$logger === void 0 ? null : _ref$logger;

		hostname == null && headers == null
			? (function () {
					var errMessage = new Error("The hostname and headers are required to make the call to the server.");
					throw errMessage;
			  })()
			: null;
		logger == null
			? (function () {
					var errMessage = new Error("The logger is required to make the call to the server. Something is wrong.");
					throw errMessage;
			  })()
			: null;
		this.hostname = hostname;
		this.headers = headers;
		this.agent = agent;
		this.logger = logger;
		this.protocol = "https:";
	}

	var _proto = Request.prototype;

	_proto.run = function run(method, path, data) {
		var _this = this;

		if (data === void 0) {
			data = null;
		}

		var dataString = data !== null ? (0, _convertValues.handleConversionObjectToString)(data) : null;
		var options = {
			path: path,
			protocol: this.protocol,
			hostname: this.hostname,
			port: 443,
			method: (0, _convertValues.handleConversionStringToUppercase)(method),
			gzip: true,
			headers: Object.assign(
				{
					"Content-Type": "application/json"
				},
				this.headers
			)
		};

		if (this.agent !== null) {
			options.agent = this.agent;
		}

		if (dataString !== null) {
			options.headers["Content-Length"] = Buffer.from(dataString).length;
		}

		return new Promise(function (resolve, reject) {
			var req = _https.default.request(options, function (res) {
				_this.logger.info("" + ("[" + method.toUpperCase() + "] " + _constants.HTTPS_PROTOCOL + _this.hostname + path));

				if (Math.round(res.statusCode / 100) === 2) {
					_this.logger.debug("" + (res.statusCode + " " + res.statusMessage));
				} else if (Math.round(res.statusCode / 100) === 4 || Math.round(res.statusCode / 100) === 5) {
					_this.logger.debug("" + (res.statusCode + " " + res.statusMessage));
				} else {
					_this.logger.debug("" + (res.statusCode + " " + res.statusMessage));
				}

				var body = "";
				var statusCode = res.statusCode;

				if (Math.round(statusCode / 100) === 4) {
					if (statusCode === 429) {
						var _res$headers$xRetry, _res$headers;

						var xRetryAfterHeader =
							(_res$headers$xRetry = res === null || res === void 0 ? void 0 : (_res$headers = res.headers) === null || _res$headers === void 0 ? void 0 : _res$headers["x-retry-after"]) !== null && _res$headers$xRetry !== void 0
								? _res$headers$xRetry
								: null;

						if (xRetryAfterHeader !== null) {
							_this.logger.info("The BigCommerce API rate limit has been reached. Please wait " + xRetryAfterHeader + " seconds before making another request.");
						}

						return setTimeout(function () {
							_this.logger.info("Restarting request...");

							_this.logger.info("" + ("[" + method.toUpperCase() + "] " + _constants.HTTPS_PROTOCOL + _this.hostname + path));

							_this.run(method, path, data).then(resolve).catch(reject);
						}, xRetryAfterHeader * 1000);
					}
				}

				res.on("data", function (chunk) {
					return (body += chunk);
				});
				res.on("end", function () {
					if (statusCode >= 400 && statusCode <= 600) {
						var errMessage = new Error("BigCommerce API request failed with status code " + statusCode + ".");
						errMessage.statusCode = statusCode;
						errMessage.body = body;
						return reject(errMessage);
					}

					return _zlib.default.gzip(body, function (err, data) {
						if (err) {
							return reject(err);
						}

						_zlib.default.gunzip(data, function (err, data) {
							if (err) {
								return reject(err);
							}

							return handleBodyResponse(res, data.toString("utf8"), resolve, reject, _this.logger);
						});
					});
				});
			});

			dataString !== null
				? (function () {
						_this.logger.info("Sending BigCommerce data...");

						_this.logger.info("" + ("[" + method.toUpperCase() + "] " + _constants.HTTPS_PROTOCOL + _this.hostname + path));

						req.write(dataString);

						_this.logger.info("Sending complete.");
				  })()
				: null;
			req.on("error", function (err) {
				return reject(err);
			});
			req.end();
		});
	};

	return Request;
})();

var _default = Request;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlscy9yZXF1ZXN0LmpzIl0sIm5hbWVzIjpbImhhbmRsZUJvZHlSZXNwb25zZSIsInJlcyIsImJvZHkiLCJyZXNvbHZlIiwicmVqZWN0IiwibG9nZ2VyIiwidGVzdCIsImhlYWRlcnMiLCJ0cmltIiwiZXJyb3IiLCJKU09OT2JqZWN0IiwiSlNPTkVycm9yIiwiSlNPTkVycm9ycyIsImVycm9ycyIsImVyciIsIkVycm9yIiwicmVzcG9uc2VCb2R5IiwiUmVxdWVzdCIsImhvc3RuYW1lIiwiYWdlbnQiLCJlcnJNZXNzYWdlIiwicHJvdG9jb2wiLCJydW4iLCJtZXRob2QiLCJwYXRoIiwiZGF0YSIsImRhdGFTdHJpbmciLCJvcHRpb25zIiwicG9ydCIsImd6aXAiLCJPYmplY3QiLCJhc3NpZ24iLCJCdWZmZXIiLCJmcm9tIiwibGVuZ3RoIiwiUHJvbWlzZSIsInJlcSIsImh0dHBzIiwicmVxdWVzdCIsImluZm8iLCJ0b1VwcGVyQ2FzZSIsIkhUVFBTX1BST1RPQ09MIiwiTWF0aCIsInJvdW5kIiwic3RhdHVzQ29kZSIsImRlYnVnIiwic3RhdHVzTWVzc2FnZSIsInhSZXRyeUFmdGVySGVhZGVyIiwic2V0VGltZW91dCIsInRoZW4iLCJjYXRjaCIsIm9uIiwiY2h1bmsiLCJ6bGliIiwiZ3VuemlwIiwidG9TdHJpbmciLCJ3cml0ZSIsImVuZCJdLCJtYXBwaW5ncyI6IkFBQ0E7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxTQUFTQSxrQkFBVCxDQUE0QkMsR0FBNUIsRUFBaUNDLElBQWpDLEVBQXVDQyxPQUF2QyxFQUFnREMsTUFBaEQsRUFBd0RDLE1BQXhELEVBQWdFO0FBQy9ELE1BQUk7QUFBQTs7QUFDSCxRQUFJLENBQUMsb0JBQW9CQyxJQUFwQixDQUF5QkwsR0FBRyxDQUFDTSxPQUFKLENBQVksY0FBWixDQUF6QixDQUFELElBQTBETCxJQUFJLENBQUNNLElBQUwsT0FBZ0IsRUFBOUUsRUFBa0Y7QUFDakZILE1BQUFBLE1B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QUFMLENBQVlrQyxJQUFaLE9BQW9CLE1BQU1oQixNQUFNLENBQUNpQixXQUFQLEVBQU4sR0FBNkIsSUFBN0IsR0FBb0NDLHlCQUFwQyxHQUFxRCxLQUFJLENBQUN2QixRQUExRCxHQUFxRU0sSUFBekY7O0FBRUFZLFFBQUFBLEdBQUcsQ0FBQ29CLEtBQUosQ0FBVTlCLFVBQVY7O0FBRUEsUUFBQSxLQUFJLENBQUNyQixNQUFMLENBQVlrQyxJQUFaLENBQWlCLG1CQUFqQjtBQUNDLE9BVkQsRUFESCxHQVlHLElBWkg7QUFlQUgsTUFBQUEsR0FBRyxDQUFDZSxFQUFKLENBQU8sT0FBUCxFQUFnQixVQUFDckMsR0FBRDtBQUFBLGVBQVNWLE1BQU0sQ0FBQ1UsR0FBRCxDQUFmO0FBQUEsT0FBaEI7QUFHQXNCLE1BQUFBLEdBQUcsQ0FBQ3FCLEdBQUo7QUFDQSxLQXhGTSxDQUFQO0FBeUZBLEc7Ozs7O2VBR2F4QyxPIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgbm8tdW5kZWYgKi9cblwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgaHR0cHMgZnJvbSBcImh0dHBzXCI7XG5pbXBvcnQgemxpYiBmcm9tIFwiemxpYlwiO1xuaW1wb3J0IHsgSFRUUFNfUFJPVE9DT0wgfSBmcm9tIFwiLi4vY29uc3RhbnRzXCI7XG5pbXBvcnQgeyBoYW5kbGVDb252ZXJzaW9uT2JqZWN0VG9TdHJpbmcsIGhhbmRsZUNvbnZlcnNpb25TdHJpbmdUb09iamVjdCwgaGFuZGxlQ29udmVyc2lvblN0cmluZ1RvVXBwZXJjYXNlIH0gZnJvbSBcIi4vY29udmVydFZhbHVlc1wiO1xuXG4vLyBIYW5kbGUgcGFyc2luZyB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgQmlnQ29tbWVyY2UgQVBJXG5mdW5jdGlvbiBoYW5kbGVCb2R5UmVzcG9uc2UocmVzLCBib2R5LCByZXNvbHZlLCByZWplY3QsIGxvZ2dlcikge1xuXHR0cnkge1xuXHRcdGlmICghL2FwcGxpY2F0aW9uXFwvanNvbi8udGVzdChyZXMuaGVhZGVyc1tcImNvbnRlbnQtdHlwZVwiXSkgfHwgYm9keS50cmltKCkgPT09IFwiXCIpIHtcblx0XHRcdGxvZ2dlci5lcnJvcihcIlRoZSByZXNwb25zZSBib2R5IGZyb20gdGhlIEJpZ0NvbW1lcmNlIEFQSSBpcyBub3QgaW4gSlNPTiBmb3JtYXQuXCIpO1xuXG5cdFx0XHRyZXR1cm4gcmVzb2x2ZShib2R5KTtcblx0XHR9XG5cblx0XHQvLyBDb252ZXJ0IHN0cmluZyB0byBvYmplY3Rcblx0XHRjb25zdCBKU09OT2JqZWN0ID0gaGFuZGxlQ29udmVyc2lvblN0cmluZ1RvT2JqZWN0KGJvZHkpO1xuXG5cdFx0Ly8gQ2hlY2sgZm9yIGVycm9ycyBpbiB0aGUgYm9keSByZXNwb25zZSwgaWYgdGhlcmUgaXMgZm91bmQsIHJlamVjdCB0aGUgcHJvbWlzZVxuXHRcdGNvbnN0IEpTT05FcnJvciA9IEpTT05PYmplY3Q/LmVycm9yID8/IG51bGw7XG5cdFx0Y29uc3QgSlNPTkVycm9ycyA9IEpTT05PYmplY3Q/LmVycm9ycyA/PyBudWxsO1xuXG5cdFx0aWYgKEpTT05FcnJvciAhPT0gbnVsbCB8fCBKU09ORXJyb3JzICE9PSBudWxsKSB7XG5cdFx0XHRjb25zdCBlcnIgPSBuZXcgRXJyb3IoSlNPTkVycm9yIHx8IGhhbmRsZUNvbnZlcnNpb25PYmplY3RUb1N0cmluZyhKU09ORXJyb3JzKSk7XG5cblx0XHRcdHJldHVybiByZWplY3QoZXJyKTtcblx0XHR9XG5cblx0XHQvLyBSZXR1cm4gdGhlIGJvZHkgcmVzcG9uc2UgYXMgYSBKU09OIG9iamVjdFxuXHRcdHJldHVybiByZXNvbHZlKEpTT05PYmplY3QpO1xuXHR9IGNhdGNoIChlcnIpIHtcblx0XHRlcnIucmVzcG9uc2VCb2R5ID0gYm9keTtcblxuXHRcdHJldHVybiByZWplY3QoZXJyKTtcblx0fVxufVxuY2xhc3MgUmVxdWVzdCB7XG5cdGNvbnN0cnVjdG9yKGhvc3RuYW1lID0gbnVsbCwgeyBoZWFkZXJzID0ge30sIGFnZW50ID0gbnVsbCwgbG9nZ2VyID0gbnVsbCB9ID0ge30pIHtcblx0XHRob3N0bmFtZSA9PSBudWxsICYmIGhlYWRlcnMgPT0gbnVsbFxuXHRcdFx0PyAoKCkgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IGVyck1lc3NhZ2UgPSBuZXcgRXJyb3IoXCJUaGUgaG9zdG5hbWUgYW5kIGhlYWRlcnMgYXJlIHJlcXVpcmVkIHRvIG1ha2UgdGhlIGNhbGwgdG8gdGhlIHNlcnZlci5cIik7XG5cblx0XHRcdFx0XHR0aHJvdyBlcnJNZXNzYWdlO1xuXHRcdFx0ICB9KSgpXG5cdFx0XHQ6IG51bGw7XG5cblx0XHRsb2dnZXIgPT0gbnVsbFxuXHRcdFx0PyAoKCkgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IGVyck1lc3NhZ2UgPSBuZXcgRXJyb3IoXCJUaGUgbG9nZ2VyIGlzIHJlcXVpcmVkIHRvIG1ha2UgdGhlIGNhbGwgdG8gdGhlIHNlcnZlci4gU29tZXRoaW5nIGlzIHdyb25nLlwiKTtcblxuXHRcdFx0XHRcdHRocm93IGVyck1lc3NhZ2U7XG5cdFx0XHQgIH0pKClcblx0XHRcdDogbnVsbDtcblxuXHRcdHRoaXMuaG9zdG5hbWUgPSBob3N0bmFtZTtcblx0XHR0aGlzLmhlYWRlcnMgPSBoZWFkZXJzO1xuXHRcdHRoaXMuYWdlbnQgPSBhZ2VudDtcblx0XHR0aGlzLmxvZ2dlciA9IGxvZ2dlcjtcblx0XHR0aGlzLnByb3RvY29sID0gXCJodHRwczpcIjtcblx0fVxuXG5cdC8vIEhhbmRsZSBydW5uaW5nIHBsdWdpblxuXHRydW4obWV0aG9kLCBwYXRoLCBkYXRhID0gbnVsbCkge1xuXHRcdGNvbnN0IGRhdGFTdHJpbmcgPSBkYXRhICE9PSBudWxsID8gaGFuZGxlQ29udmVyc2lvbk9iamVjdFRvU3RyaW5nKGRhdGEpIDogbnVsbDtcblxuXHRcdGNvbnN0IG9wdGlvbnMgPSB7XG5cdFx0XHRwYXRoOiBwYXRoLFxuXHRcdFx0cHJvdG9jb2w6IHRoaXMucHJvdG9jb2wsXG5cdFx0XHRob3N0bmFtZTogdGhpcy5ob3N0bmFtZSxcblx0XHRcdHBvcnQ6IDQ0Myxcblx0XHRcdG1ldGhvZDogaGFuZGxlQ29udmVyc2lvblN0cmluZ1RvVXBwZXJjYXNlKG1ldGhvZCksXG5cdFx0XHRnemlwOiB0cnVlLFxuXHRcdFx0aGVhZGVyczogT2JqZWN0LmFzc2lnbihcblx0XHRcdFx0e1xuXHRcdFx0XHRcdFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiXG5cdFx0XHRcdH0sXG5cdFx0XHRcdHRoaXMuaGVhZGVyc1xuXHRcdFx0KVxuXHRcdH07XG5cblx0XHRpZiAodGhpcy5hZ2VudCAhPT0gbnVsbCkge1xuXHRcdFx0b3B0aW9ucy5hZ2VudCA9IHRoaXMuYWdlbnQ7XG5cdFx0fVxuXG5cdFx0aWYgKGRhdGFTdHJpbmcgIT09IG51bGwpIHtcblx0XHRcdG9wdGlvbnMuaGVhZGVyc1tcIkNvbnRlbnQtTGVuZ3RoXCJdID0gQnVmZmVyLmZyb20oZGF0YVN0cmluZykubGVuZ3RoO1xuXHRcdH1cblxuXHRcdHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0XHRjb25zdCByZXEgPSBodHRwcy5yZXF1ZXN0KG9wdGlvbnMsIChyZXMpID0+IHtcblx0XHRcdFx0Ly8gU2VuZCBsb2cgbWVzc2FnZSB3aGVuIHJlcXVlc3RpbmcgZGF0YVxuXHRcdFx0XHR0aGlzLmxvZ2dlci5pbmZvKGAke1wiW1wiICsgbWV0aG9kLnRvVXBwZXJDYXNlKCkgKyBcIl0gXCIgKyBIVFRQU19QUk9UT0NPTCArIHRoaXMuaG9zdG5hbWUgKyBwYXRofWApO1xuXG5cdFx0XHRcdGlmIChNYXRoLnJvdW5kKHJlcy5zdGF0dXNDb2RlIC8gMTAwKSA9PT0gMikge1xuXHRcdFx0XHRcdHRoaXMubG9nZ2VyLmRlYnVnKGAke3Jlcy5zdGF0dXNDb2RlICsgXCIgXCIgKyByZXMuc3RhdHVzTWVzc2FnZX1gKTtcblx0XHRcdFx0fSBlbHNlIGlmIChNYXRoLnJvdW5kKHJlcy5zdGF0dXNDb2RlIC8gMTAwKSA9PT0gNCB8fCBNYXRoLnJvdW5kKHJlcy5zdGF0dXNDb2RlIC8gMTAwKSA9PT0gNSkge1xuXHRcdFx0XHRcdHRoaXMubG9nZ2VyLmRlYnVnKGAke3Jlcy5zdGF0dXNDb2RlICsgXCIgXCIgKyByZXMuc3RhdHVzTWVzc2FnZX1gKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHR0aGlzLmxvZ2dlci5kZWJ1ZyhgJHtyZXMuc3RhdHVzQ29kZSArIFwiIFwiICsgcmVzLnN0YXR1c01lc3NhZ2V9YCk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRsZXQgYm9keSA9IFwiXCI7XG5cblx0XHRcdFx0Ly8gSGFuZGxlIEFQSSByYXRlIGxpbWl0XG5cdFx0XHRcdGNvbnN0IHN0YXR1c0NvZGUgPSByZXMuc3RhdHVzQ29kZTtcblxuXHRcdFx0XHRpZiAoTWF0aC5yb3VuZChzdGF0dXNDb2RlIC8gMTAwKSA9PT0gNCkge1xuXHRcdFx0XHRcdGlmIChzdGF0dXNDb2RlID09PSA0MjkpIHtcblx0XHRcdFx0XHRcdGNvbnN0IHhSZXRyeUFmdGVySGVhZGVyID0gcmVzPy5oZWFkZXJzPy5bXCJ4LXJldHJ5LWFmdGVyXCJdID8/IG51bGw7XG5cblx0XHRcdFx0XHRcdGlmICh4UmV0cnlBZnRlckhlYWRlciAhPT0gbnVsbCkge1xuXHRcdFx0XHRcdFx0XHR0aGlzLmxvZ2dlci5pbmZvKGBUaGUgQmlnQ29tbWVyY2UgQVBJIHJhdGUgbGltaXQgaGFzIGJlZW4gcmVhY2hlZC4gUGxlYXNlIHdhaXQgJHt4UmV0cnlBZnRlckhlYWRlcn0gc2Vjb25kcyBiZWZvcmUgbWFraW5nIGFub3RoZXIgcmVxdWVzdC5gKTtcblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0cmV0dXJuIHNldFRpbWVvdXQoKCkgPT4ge1xuXHRcdFx0XHRcdFx0XHQvLyBTZW5kIGxvZyBtZXNzYWdlIHdoZW4gcmVzdGFydGluZyByZXF1ZXN0XG5cdFx0XHRcdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXCJSZXN0YXJ0aW5nIHJlcXVlc3QuLi5cIik7XG5cblx0XHRcdFx0XHRcdFx0Ly8gU2VuZCBsb2cgbWVzc2FnZSB3aGVuIHJlc3RhcnRpbmcgcmVxdWVzdFxuXHRcdFx0XHRcdFx0XHR0aGlzLmxvZ2dlci5pbmZvKGAke1wiW1wiICsgbWV0aG9kLnRvVXBwZXJDYXNlKCkgKyBcIl0gXCIgKyBIVFRQU19QUk9UT0NPTCArIHRoaXMuaG9zdG5hbWUgKyBwYXRofWApO1xuXG5cdFx0XHRcdFx0XHRcdHRoaXMucnVuKG1ldGhvZCwgcGF0aCwgZGF0YSkudGhlbihyZXNvbHZlKS5jYXRjaChyZWplY3QpO1xuXHRcdFx0XHRcdFx0fSwgeFJldHJ5QWZ0ZXJIZWFkZXIgKiAxMDAwKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblxuXHRcdFx0XHQvLyBBcHBlbmQgdGhlIHJlc3BvbnNlIGJvZHkgdG8gdGhlIGJvZHkgdmFyaWFibGVcblx0XHRcdFx0cmVzLm9uKFwiZGF0YVwiLCAoY2h1bmspID0+IChib2R5ICs9IGNodW5rKSk7XG5cblx0XHRcdFx0Ly8gRW5kIEJpZ0NvbW1lcmNlIHJlc3BvbnNlIGV4ZWN1dGlvblxuXHRcdFx0XHRyZXMub24oXCJlbmRcIiwgKCkgPT4ge1xuXHRcdFx0XHRcdGlmIChzdGF0dXNDb2RlID49IDQwMCAmJiBzdGF0dXNDb2RlIDw9IDYwMCkge1xuXHRcdFx0XHRcdFx0Y29uc3QgZXJyTWVzc2FnZSA9IG5ldyBFcnJvcihgQmlnQ29tbWVyY2UgQVBJIHJlcXVlc3QgZmFpbGVkIHdpdGggc3RhdHVzIGNvZGUgJHtzdGF0dXNDb2RlfS5gKTtcblx0XHRcdFx0XHRcdGVyck1lc3NhZ2Uuc3RhdHVzQ29kZSA9IHN0YXR1c0NvZGU7XG5cdFx0XHRcdFx0XHRlcnJNZXNzYWdlLmJvZHkgPSBib2R5O1xuXG5cdFx0XHRcdFx0XHRyZXR1cm4gcmVqZWN0KGVyck1lc3NhZ2UpO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdC8vIENhbGxpbmcgZ3ppcCBtZXRob2Rcblx0XHRcdFx0XHRyZXR1cm4gemxpYi5nemlwKGJvZHksIChlcnIsIGRhdGEpID0+IHtcblx0XHRcdFx0XHRcdGlmIChlcnIpIHtcblx0XHRcdFx0XHRcdFx0cmV0dXJuIHJlamVjdChlcnIpO1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHQvLyBDYWxsaW5nIGd1bnppcCBtZXRob2Rcblx0XHRcdFx0XHRcdHpsaWIuZ3VuemlwKGRhdGEsIChlcnIsIGRhdGEpID0+IHtcblx0XHRcdFx0XHRcdFx0aWYgKGVycikge1xuXHRcdFx0XHRcdFx0XHRcdHJldHVybiByZWplY3QoZXJyKTtcblx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdHJldHVybiBoYW5kbGVCb2R5UmVzcG9uc2UocmVzLCBkYXRhLnRvU3RyaW5nKFwidXRmOFwiKSwgcmVzb2x2ZSwgcmVqZWN0LCB0aGlzLmxvZ2dlcik7XG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fSk7XG5cdFx0XHR9KTtcblxuXHRcdFx0ZGF0YVN0cmluZyAhPT0gbnVsbFxuXHRcdFx0XHQ/ICgoKSA9PiB7XG5cdFx0XHRcdFx0XHQvLyBTZW5kIGxvZyBtZXNzYWdlIHdoZW4gc2VuZGluZyBkYXRhXG5cdFx0XHRcdFx0XHR0aGlzLmxvZ2dlci5pbmZvKFwiU2VuZGluZyBCaWdDb21tZXJjZSBkYXRhLi4uXCIpO1xuXG5cdFx0XHRcdFx0XHQvLyBTZW5kIGxvZyBtZXNzYWdlIHdoZW4gcmVxdWVzdGluZyBkYXRhXG5cdFx0XHRcdFx0XHR0aGlzLmxvZ2dlci5pbmZvKGAke1wiW1wiICsgbWV0aG9kLnRvVXBwZXJDYXNlKCkgKyBcIl0gXCIgKyBIVFRQU19QUk9UT0NPTCArIHRoaXMuaG9zdG5hbWUgKyBwYXRofWApO1xuXG5cdFx0XHRcdFx0XHRyZXEud3JpdGUoZGF0YVN0cmluZyk7XG5cblx0XHRcdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXCJTZW5kaW5nIGNvbXBsZXRlLlwiKTtcblx0XHRcdFx0ICB9KSgpXG5cdFx0XHRcdDogbnVsbDtcblxuXHRcdFx0Ly8gSGFuZGxlIEJpZ0NvbW1lcmNlIEFQSSByZXF1ZXN0IGVycm9yc1xuXHRcdFx0cmVxLm9uKFwiZXJyb3JcIiwgKGVycikgPT4gcmVqZWN0KGVycikpO1xuXG5cdFx0XHQvLyBFbmQgQmlnQ29tbWVyY2UgcmVxdWVzdCBleGVjdXRpb25cblx0XHRcdHJlcS5lbmQoKTtcblx0XHR9KTtcblx0fVxufVxuXG5leHBvcnQgZGVmYXVsdCBSZXF1ZXN0O1xuIl19
