{"version":3,"sources":["../src/utils/bigcommerce.js"],"names":["BigCommerce","config","errMessage","Error","grantType","createAPIRequest","endpoint","accept","responseType","Request","headers","Object","assign","clientId","accessToken","logger","agent","verify","signedRequest","error","splitRequest","split","length","signature","Buffer","from","toString","json","data","expected","crypto","createHmac","secret","update","digest","info","timingSafeEqual","authorize","query","code","scope","context","queryCode","queryScope","queryContext","payload","client_id","client_secret","grant_type","request","REQUEST_BIGCOMMERCE_LOGIN_URL","oauthToken","run","type","path","storeHash","extension","REQUEST_BIGCOMMERCE_API_URL","version","includes","replace","fullPath","response","meta","pagination","totalPages","total_pages","currentPage","current_page","promises","nextPage","endpointUrl","URL","hostname","searchParams","set","push","pathname","search","Promise","all","responses","forEach","pageResponse","concat","get","post","put","delete"],"mappings":"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","sourcesContent":["/* eslint-disable no-undef */\n\"use strict\";\n\nimport crypto from \"crypto\";\nimport { REQUEST_BIGCOMMERCE_API_URL, REQUEST_BIGCOMMERCE_LOGIN_URL } from \"../constants\";\nimport { handleConversionStringToObject } from \"./convertValues\";\nimport Request from \"./request\";\n\nclass BigCommerce {\n\tconstructor(config) {\n\t\tif (!config) {\n\t\t\tconst errMessage = new Error(\"Config missing. The config object is required to make any call to the BigCommerce API\");\n\n\t\t\tthrow errMessage;\n\t\t}\n\n\t\tthis.config = config;\n\t\tthis.grantType = \"authorization_code\";\n\t}\n\n\t// Handle creating API request\n\tcreateAPIRequest(endpoint) {\n\t\tconst accept = this.config.responseType === \"xml\" ? \"application/xml\" : \"application/json\";\n\n\t\treturn new Request(endpoint, {\n\t\t\theaders: Object.assign(\n\t\t\t\t{\n\t\t\t\t\t\"Accept\": accept,\n\t\t\t\t\t\"X-Auth-Client\": this.config.clientId,\n\t\t\t\t\t\"X-Auth-Token\": this.config.accessToken\n\t\t\t\t},\n\t\t\t\tthis.config.headers\n\t\t\t),\n\t\t\tlogger: this.config.logger,\n\t\t\tagent: this.config.agent\n\t\t});\n\t}\n\n\t// Handle verfiy signed request\n\tasync verify(signedRequest) {\n\t\t// If `signedRequest` is \"undefined\", throw an error\n\t\t!signedRequest ? this.config.logger.error(\"The signed request is required to verify the call.\") : null;\n\n\t\tconst splitRequest = signedRequest.split(\".\");\n\n\t\t// If `splitRequest` length is less than 2, throw an error\n\t\tsplitRequest.length < 2 ? this.config.logger.error(\"The signed request will come in two parts seperated by a .(full stop). \" + \"this signed request contains less than 2 parts.\") : null;\n\n\t\t// Check and verify validity of signatures\n\t\tconst signature = Buffer.from(splitRequest[1], \"base64\").toString(\"utf8\");\n\t\tconst json = Buffer.from(splitRequest[0], \"base64\").toString(\"utf8\");\n\t\tconst data = handleConversionStringToObject(json);\n\t\tconst expected = crypto.createHmac(\"sha256\", this.config.secret).update(json).digest(\"hex\");\n\n\t\tthis.config.logger.info(\"JSON: \" + json);\n\t\tthis.config.logger.info(\"SIGNATURE: \" + signature);\n\t\tthis.config.logger.info(\"EXPECTED SIGNATURE: \" + expected);\n\n\t\t// If the expected length of signature doesn't match the current signature length, throw an error, otherwise return data\n\t\texpected.length !== signature.length || crypto.timingSafeEqual(Buffer.from(expected, \"utf8\"), Buffer.from(signature, \"utf8\")) ? this.config.logger.error(\"The signature is invalid.\") : null;\n\n\t\t// Send log message when signature is valid\n\t\tthis.config.logger.info(\"The signature is valid.\");\n\n\t\treturn data;\n\t}\n\n\t// Handle authentication request\n\tasync authorize(query) {\n\t\t// if `query` is undefined, throw an error\n\t\t!query ? this.config.logger.error(\"The URL query paramaters are required.\") : null;\n\n\t\t// Query props\n\t\tconst { code, scope, context } = await query;\n\t\tconst queryCode = code ?? null;\n\t\tconst queryScope = scope ?? null;\n\t\tconst queryContext = context ?? null;\n\n\t\t// Init payload\n\t\tconst payload = {\n\t\t\tclient_id: this.config.clientId,\n\t\t\tclient_secret: this.config.secret,\n\t\t\tgrant_type: this.grantType,\n\t\t\tcode: queryCode,\n\t\t\tscope: queryScope,\n\t\t\tcontext: queryContext\n\t\t};\n\n\t\t// Run request\n\t\tconst request = this.createAPIRequest(REQUEST_BIGCOMMERCE_LOGIN_URL);\n\t\tconst oauthToken = \"/oauth2/token\";\n\n\t\treturn await request.run(\"post\", oauthToken, payload);\n\t}\n\n\t// Handle API requests\n\tasync request(type, path, data = null) {\n\t\t// If current `config` have undefined `accessToken`, throw an error\n\t\tthis.config.accessToken == null ? this.config.logger.error(\"The access token is required to make BigCommerce API requests.\") : null;\n\n\t\t// If current `config` have undefined `storeHash`, throw an error\n\t\tthis.config.storeHash == null ? this.config.logger.error(\"The store hash is required to make BigCommerce API requests.\") : null;\n\n\t\t// Prepare `path` for request execution\n\t\tconst extension = this.config.responseType === \"xml\" ? \".xml\" : \"\";\n\t\tconst request = this.createAPIRequest(REQUEST_BIGCOMMERCE_API_URL);\n\t\tconst version = !path.includes(\"v3\") ? path.replace(/(\\?|$)/, extension + \"$1\") : path;\n\n\t\t// Update full path\n\t\tlet fullPath = `/stores/${this.config.storeHash}`;\n\n\t\tfullPath += version;\n\n\t\tconst response = await request.run(type, fullPath, data);\n\n\t\t// If response contains pagination.\n\t\tif (\"meta\" in response && \"pagination\" in response.meta) {\n\t\t\tconst { total_pages: totalPages, current_page: currentPage } = response.meta.pagination;\n\n\t\t\t// If current page is not the last page.\n\t\t\tif (totalPages > currentPage) {\n\t\t\t\t// Collect all page request promises in array.\n\t\t\t\tconst promises = [];\n\n\t\t\t\tfor (let nextPage = currentPage + 1; nextPage <= totalPages; nextPage++) {\n\t\t\t\t\tconst endpointUrl = new URL(fullPath, `https://${request.hostname}`);\n\n\t\t\t\t\t// Safely assign `page` query parameter to endpoint URL.\n\t\t\t\t\tendpointUrl.searchParams.set(\"page\", nextPage);\n\n\t\t\t\t\t// Add promise to array for future Promise.All() call.\n\t\t\t\t\tpromises.push(request.run(type, `${endpointUrl.pathname}${endpointUrl.search}`, data));\n\t\t\t\t}\n\n\t\t\t\t// Request all endpoints in parallel.\n\t\t\t\tconst responses = await Promise.all(promises);\n\n\t\t\t\tresponses.forEach((pageResponse) => {\n\t\t\t\t\tresponse.data = response.data.concat(pageResponse.data);\n\t\t\t\t});\n\n\t\t\t\t// Set pager to last page.\n\t\t\t\tresponse.meta.pagination.total_pages = totalPages;\n\t\t\t\tresponse.meta.pagination.current_page = totalPages;\n\t\t\t}\n\t\t}\n\n\t\t// Run request\n\t\treturn response;\n\t}\n\n\t// Handle `GET` request\n\tasync get(path) {\n\t\treturn await this.request(\"get\", path);\n\t}\n\n\t// Handle `POST` request\n\tasync post(path, data) {\n\t\treturn await this.request(\"post\", path, data);\n\t}\n\n\t// Handle `PUT` request\n\tasync put(path, data) {\n\t\treturn await this.request(\"put\", path, data);\n\t}\n\n\t// Handle `DELETE` request\n\tasync delete(path) {\n\t\treturn await this.request(\"delete\", path);\n\t}\n}\n\nexport default BigCommerce;\n"],"file":"bigcommerce.js"}