{"version":3,"file":"sourceNodes.js","names":["exports","sourceNodes","configOptions","actions","createNodeId","createContentDigest","createNode","endpoints","clientId","secret","storeHash","accessToken","hostname","preview","errMessage","console","log","FG_YELLOW","BC","BigCommerce","responseType","Object","keys","length","FG_GREEN","Promise","all","entries","map","nodeName","endpoint","get","then","res","resData","Array","isArray","data","datum","id","bigcommerce_id","parent","children","internal","type","content","handleConversionObjectToString","contentDigest","catch","err","Error","finally","IS_DEV","webhookEndpoint","body","scope","is_active","destination","post","server","micro","req","json","request","productId","newProduct","nodeToUpdate","end","listen","exitMessage","error","FG_RED","onCreateDevServer","app","use","createProxyMiddleware","target","secure"],"sources":["../src/gatsby/sourceNodes.js"],"sourcesContent":["\"use strict\";\n\nimport { createProxyMiddleware } from \"http-proxy-middleware\";\nimport micro from \"micro\";\nimport { FG_GREEN, FG_RED, FG_YELLOW, IS_DEV } from \"../constants\";\nimport BigCommerce from \"../utils/bigcommerce\";\nimport { handleConversionObjectToString } from \"../utils/convertValues\";\n\nexports.sourceNodes = async ({ actions, createNodeId, createContentDigest }, configOptions) => {\n\tconst { createNode } = actions;\n\tconst { endpoints = null, clientId = null, secret = null, storeHash = null, accessToken = null, hostname = null, preview = false } = configOptions;\n\n\t// Custom variables\n\tlet errMessage = \"\";\n\n\t// Send log message when checking for required options\n\tconsole.log(FG_YELLOW, \"\\nChecking BigCommerce plugin options... \");\n\n\tif (endpoints !== null && clientId !== null && secret !== null && storeHash !== null && accessToken !== null) {\n\t\t// Init new `BigCommerce` instance\n\t\tconst BC = new BigCommerce({\n\t\t\tclientId,\n\t\t\taccessToken,\n\t\t\tsecret,\n\t\t\tstoreHash,\n\t\t\tresponseType: \"json\"\n\t\t});\n\n\t\t// Handle fetching and creating nodes for a single or multiple endpoints\n\t\tif (endpoints && typeof endpoints === \"object\" && Object.keys(endpoints).length > 0) {\n\t\t\t// Send log message when fetching data\n\t\t\tconsole.log(FG_GREEN, \"\\nValid plugin options found. Proceeding with plugin initialization...\");\n\t\t\tconsole.log(FG_YELLOW, \"\\nRequesting endpoint data...\\n\");\n\n\t\t\tawait Promise.all(\n\t\t\t\tObject.entries(endpoints).map(([nodeName, endpoint]) => {\n\t\t\t\t\treturn BC.get(endpoint).then((res) => {\n\t\t\t\t\t\t// If the data object is not on the response, it could be `v2` which returns an array as the root, so use that as a fallback\n\t\t\t\t\t\tconst resData = \"data\" in res && Array.isArray(res.data) ? res.data : res;\n\n\t\t\t\t\t\t// Handle generating nodes\n\t\t\t\t\t\treturn \"data\" in res && Array.isArray(res.data)\n\t\t\t\t\t\t\t? resData.map((datum) =>\n\t\t\t\t\t\t\t\t\tcreateNode({\n\t\t\t\t\t\t\t\t\t\t...datum,\n\t\t\t\t\t\t\t\t\t\tid: createNodeId(`${datum.id + \"-\" + nodeName}`),\n\t\t\t\t\t\t\t\t\t\tbigcommerce_id: datum.id,\n\t\t\t\t\t\t\t\t\t\tparent: null,\n\t\t\t\t\t\t\t\t\t\tchildren: [],\n\t\t\t\t\t\t\t\t\t\tinternal: {\n\t\t\t\t\t\t\t\t\t\t\ttype: nodeName,\n\t\t\t\t\t\t\t\t\t\t\tcontent: handleConversionObjectToString(datum),\n\t\t\t\t\t\t\t\t\t\t\tcontentDigest: createContentDigest(datum)\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t: Array.isArray(res)\n\t\t\t\t\t\t\t? res.map((datum) =>\n\t\t\t\t\t\t\t\t\tcreateNode({\n\t\t\t\t\t\t\t\t\t\t...datum,\n\t\t\t\t\t\t\t\t\t\tid: createNodeId(`${datum.id + \"-\" + nodeName}`),\n\t\t\t\t\t\t\t\t\t\tbigcommerce_id: datum.id,\n\t\t\t\t\t\t\t\t\t\tparent: null,\n\t\t\t\t\t\t\t\t\t\tchildren: [],\n\t\t\t\t\t\t\t\t\t\tinternal: {\n\t\t\t\t\t\t\t\t\t\t\ttype: nodeName,\n\t\t\t\t\t\t\t\t\t\t\tcontent: handleConversionObjectToString(datum),\n\t\t\t\t\t\t\t\t\t\t\tcontentDigest: createContentDigest(datum)\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t: createNode({\n\t\t\t\t\t\t\t\t\t...resData,\n\t\t\t\t\t\t\t\t\tid: createNodeId(`${resData.id + \"-\" + nodeName}`),\n\t\t\t\t\t\t\t\t\tparent: null,\n\t\t\t\t\t\t\t\t\tchildren: [],\n\t\t\t\t\t\t\t\t\tinternal: {\n\t\t\t\t\t\t\t\t\t\ttype: nodeName,\n\t\t\t\t\t\t\t\t\t\tcontent: handleConversionObjectToString(resData),\n\t\t\t\t\t\t\t\t\t\tcontentDigest: createContentDigest(resData)\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t  });\n\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t)\n\t\t\t\t.then(() => {\n\t\t\t\t\t// Send log message when all endpoints have been fetched\n\t\t\t\t\tconsole.log(FG_GREEN, \"\\nAll endpoint data have been fetched successfully.\");\n\t\t\t\t})\n\t\t\t\t.catch((err) => {\n\t\t\t\t\t// Send log message when an error occurs\n\t\t\t\t\terrMessage = new Error(`An error occurred while fetching endpoint data. ${err}`);\n\t\t\t\t})\n\t\t\t\t.finally(() =>\n\t\t\t\t\t// Send log message when fetching data is complete\n\t\t\t\t\tconsole.log(FG_YELLOW, \"\\nRequesting endpoint data complete.\\n\")\n\t\t\t\t);\n\t\t} else {\n\t\t\terrMessage = new Error(\"The `endpoints` object is required to make any call to the BigCommerce API\");\n\t\t}\n\n\t\tif (IS_DEV && preview) {\n\t\t\t// Make a `POST` request to the BigCommerce API to subscribe to its webhook\n\t\t\tconst webhookEndpoint = \"/v3/hooks\";\n\t\t\tconst body = {\n\t\t\t\tscope: \"store/product/updated\",\n\t\t\t\tis_active: true,\n\t\t\t\tdestination: `${hostname}/__BCPreview`\n\t\t\t};\n\n\t\t\tawait BC.get(webhookEndpoint).then((res) => {\n\t\t\t\tif (\"data\" in res && Object.keys(res.data).length > 0) {\n\t\t\t\t\treturn res.data;\n\t\t\t\t} else return (async () => await BC.post(webhookEndpoint, body).then((res) => res))();\n\t\t\t});\n\n\t\t\tconst server = micro(async (req, res) => {\n\t\t\t\tconst request = await micro.json(req);\n\t\t\t\tconst productId = request.data.id;\n\n\t\t\t\t// Webhooks don't send any data, so we need to make a request to the BigCommerce API to get the product data\n\t\t\t\tconst newProduct = await BC.get(`/catalog/products/${productId}`);\n\t\t\t\tconst nodeToUpdate = newProduct.data;\n\n\t\t\t\tif (nodeToUpdate.id) {\n\t\t\t\t\tcreateNode({\n\t\t\t\t\t\t...nodeToUpdate,\n\t\t\t\t\t\tid: createNodeId(`${nodeToUpdate?.id ?? `BigCommerceNode`}`),\n\t\t\t\t\t\tparent: null,\n\t\t\t\t\t\tchildren: [],\n\t\t\t\t\t\tinternal: {\n\t\t\t\t\t\t\ttype: `BigCommerceNode`,\n\t\t\t\t\t\t\tcontentDigest: createContentDigest(nodeToUpdate)\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\tconsole.log(FG_YELLOW, `\\nUpdated node: ${nodeToUpdate.id}`);\n\t\t\t\t}\n\n\t\t\t\t// Send a response back to the BigCommerce API\n\t\t\t\tres.end(\"ok\");\n\t\t\t});\n\n\t\t\tserver.listen(8033, console.log(FG_YELLOW, `\\nNow listening to changes for live preview at /__BCPreview\\n`));\n\t\t}\n\t} else {\n\t\t// If `endpoints` is null, throw an error\n\t\tif (endpoints == null) {\n\t\t\terrMessage = new Error(\"The `endpoints` are required to make any call to the BigCommerce API\");\n\t\t}\n\n\t\t// If `clientId` is null, throw an error\n\t\tif (clientId == null) {\n\t\t\terrMessage = new Error(\"The `clientId` is required to make any call to the BigCommerce API\");\n\t\t}\n\n\t\t// If `secret` is null, throw an error\n\t\tif (secret == null) {\n\t\t\terrMessage = new Error(\"The `secret` is required to make any call to the BigCommerce API\");\n\t\t}\n\n\t\t// If `storeHash` is null, throw an error\n\t\tif (storeHash == null) {\n\t\t\terrMessage = new Error(\"The `storeHash` is required to make any call to the BigCommerce API\");\n\t\t}\n\n\t\t// If `accessToken` is null, throw an error\n\t\tif (accessToken == null) {\n\t\t\terrMessage = new Error(\"The `accessToken` is required to make any call to the BigCommerce API\");\n\t\t}\n\t}\n\n\tif (errMessage !== \"\") {\n\t\tconst exitMessage = \"\\nPlugin terminated with errors...\\n\";\n\n\t\tconsole.error(FG_RED, exitMessage);\n\n\t\tthrow errMessage;\n\t}\n};\n\nexports.onCreateDevServer = ({ app }) => {\n\tapp.use(\n\t\t\"/__BCPreview/\",\n\t\tcreateProxyMiddleware({\n\t\t\ttarget: `http://localhost:8033`,\n\t\t\tsecure: false\n\t\t})\n\t);\n};\n"],"mappings":"AAAA;;;;;;;;;;AAEA;;AACA;;AACA;;AACA;;AACA;;AAEAA,OAAO,CAACC,WAAR;EAAA,sEAAsB,wBAAuDC,aAAvD;IAAA;;IAAA;MAAA;QAAA;UAAA;YAASC,OAAT,QAASA,OAAT,EAAkBC,YAAlB,QAAkBA,YAAlB,EAAgCC,mBAAhC,QAAgCA,mBAAhC;YACbC,UADa,GACEH,OADF,CACbG,UADa;YAAA,wBAEgHJ,aAFhH,CAEbK,SAFa,EAEbA,SAFa,sCAED,IAFC,kDAEgHL,aAFhH,CAEKM,QAFL,EAEKA,QAFL,sCAEgB,IAFhB,kDAEgHN,aAFhH,CAEsBO,MAFtB,EAEsBA,MAFtB,sCAE+B,IAF/B,kDAEgHP,aAFhH,CAEqCQ,SAFrC,EAEqCA,SAFrC,sCAEiD,IAFjD,kDAEgHR,aAFhH,CAEuDS,WAFvD,EAEuDA,WAFvD,sCAEqE,IAFrE,kDAEgHT,aAFhH,CAE2EU,QAF3E,EAE2EA,QAF3E,sCAEsF,IAFtF,kDAEgHV,aAFhH,CAE4FW,OAF5F,EAE4FA,OAF5F,sCAEsG,KAFtG;YAKjBC,UALiB,GAKJ,EALI;YAQrBC,OAAO,CAACC,GAAR,CAAYC,oBAAZ,EAAuB,2CAAvB;;YARqB,MAUjBV,SAAS,KAAK,IAAd,IAAsBC,QAAQ,KAAK,IAAnC,IAA2CC,MAAM,KAAK,IAAtD,IAA8DC,SAAS,KAAK,IAA5E,IAAoFC,WAAW,KAAK,IAVnF;cAAA;cAAA;YAAA;;YAYdO,EAZc,GAYT,IAAIC,oBAAJ,CAAgB;cAC1BX,QAAQ,EAARA,QAD0B;cAE1BG,WAAW,EAAXA,WAF0B;cAG1BF,MAAM,EAANA,MAH0B;cAI1BC,SAAS,EAATA,SAJ0B;cAK1BU,YAAY,EAAE;YALY,CAAhB,CAZS;;YAAA,MAqBhBb,SAAS,IAAI,OAAOA,SAAP,KAAqB,QAAlC,IAA8Cc,MAAM,CAACC,IAAP,CAAYf,SAAZ,EAAuBgB,MAAvB,GAAgC,CArB9D;cAAA;cAAA;YAAA;;YAuBnBR,OAAO,CAACC,GAAR,CAAYQ,mBAAZ,EAAsB,wEAAtB;YACAT,OAAO,CAACC,GAAR,CAAYC,oBAAZ,EAAuB,iCAAvB;YAxBmB;YAAA,OA0BbQ,OAAO,CAACC,GAAR,CACLL,MAAM,CAACM,OAAP,CAAepB,SAAf,EAA0BqB,GAA1B,CAA8B,iBAA0B;cAAA,IAAxBC,QAAwB;cAAA,IAAdC,QAAc;cACvD,OAAOZ,EAAE,CAACa,GAAH,CAAOD,QAAP,EAAiBE,IAAjB,CAAsB,UAACC,GAAD,EAAS;gBAErC,IAAMC,OAAO,GAAG,UAAUD,GAAV,IAAiBE,KAAK,CAACC,OAAN,CAAcH,GAAG,CAACI,IAAlB,CAAjB,GAA2CJ,GAAG,CAACI,IAA/C,GAAsDJ,GAAtE;gBAGA,OAAO,UAAUA,GAAV,IAAiBE,KAAK,CAACC,OAAN,CAAcH,GAAG,CAACI,IAAlB,CAAjB,GACJH,OAAO,CAACN,GAAR,CAAY,UAACU,KAAD;kBAAA,OACZhC,UAAU,4BACNgC,KADM;oBAETC,EAAE,EAAEnC,YAAY,OAAIkC,KAAK,CAACC,EAAN,GAAW,GAAX,GAAiBV,QAArB,EAFP;oBAGTW,cAAc,EAAEF,KAAK,CAACC,EAHb;oBAITE,MAAM,EAAE,IAJC;oBAKTC,QAAQ,EAAE,EALD;oBAMTC,QAAQ,EAAE;sBACTC,IAAI,EAAEf,QADG;sBAETgB,OAAO,EAAE,IAAAC,6CAAA,EAA+BR,KAA/B,CAFA;sBAGTS,aAAa,EAAE1C,mBAAmB,CAACiC,KAAD;oBAHzB;kBAND,GADE;gBAAA,CAAZ,CADI,GAeJH,KAAK,CAACC,OAAN,CAAcH,GAAd,IACAA,GAAG,CAACL,GAAJ,CAAQ,UAACU,KAAD;kBAAA,OACRhC,UAAU,4BACNgC,KADM;oBAETC,EAAE,EAAEnC,YAAY,OAAIkC,KAAK,CAACC,EAAN,GAAW,GAAX,GAAiBV,QAArB,EAFP;oBAGTW,cAAc,EAAEF,KAAK,CAACC,EAHb;oBAITE,MAAM,EAAE,IAJC;oBAKTC,QAAQ,EAAE,EALD;oBAMTC,QAAQ,EAAE;sBACTC,IAAI,EAAEf,QADG;sBAETgB,OAAO,EAAE,IAAAC,6CAAA,EAA+BR,KAA/B,CAFA;sBAGTS,aAAa,EAAE1C,mBAAmB,CAACiC,KAAD;oBAHzB;kBAND,GADF;gBAAA,CAAR,CADA,GAeAhC,UAAU,4BACP4B,OADO;kBAEVK,EAAE,EAAEnC,YAAY,OAAI8B,OAAO,CAACK,EAAR,GAAa,GAAb,GAAmBV,QAAvB,EAFN;kBAGVY,MAAM,EAAE,IAHE;kBAIVC,QAAQ,EAAE,EAJA;kBAKVC,QAAQ,EAAE;oBACTC,IAAI,EAAEf,QADG;oBAETgB,OAAO,EAAE,IAAAC,6CAAA,EAA+BZ,OAA/B,CAFA;oBAGTa,aAAa,EAAE1C,mBAAmB,CAAC6B,OAAD;kBAHzB;gBALA,GA9Bb;cAyCA,CA9CM,CAAP;YA+CA,CAhDD,CADK,EAmDJF,IAnDI,CAmDC,YAAM;cAEXjB,OAAO,CAACC,GAAR,CAAYQ,mBAAZ,EAAsB,qDAAtB;YACA,CAtDI,EAuDJwB,KAvDI,CAuDE,UAACC,GAAD,EAAS;cAEfnC,UAAU,GAAG,IAAIoC,KAAJ,sDAA6DD,GAA7D,CAAb;YACA,CA1DI,EA2DJE,OA3DI,CA2DI;cAAA,OAERpC,OAAO,CAACC,GAAR,CAAYC,oBAAZ,EAAuB,wCAAvB,CAFQ;YAAA,CA3DJ,CA1Ba;;UAAA;YAAA;YAAA;;UAAA;YA0FnBH,UAAU,GAAG,IAAIoC,KAAJ,CAAU,4EAAV,CAAb;;UA1FmB;YAAA,MA6FhBE,iBAAA,IAAUvC,OA7FM;cAAA;cAAA;YAAA;;YA+FbwC,eA/Fa,GA+FK,WA/FL;YAgGbC,IAhGa,GAgGN;cACZC,KAAK,EAAE,uBADK;cAEZC,SAAS,EAAE,IAFC;cAGZC,WAAW,EAAK7C,QAAL;YAHC,CAhGM;YAAA;YAAA,OAsGbM,EAAE,CAACa,GAAH,CAAOsB,eAAP,EAAwBrB,IAAxB,CAA6B,UAACC,GAAD,EAAS;cAC3C,IAAI,UAAUA,GAAV,IAAiBZ,MAAM,CAACC,IAAP,CAAYW,GAAG,CAACI,IAAhB,EAAsBd,MAAtB,GAA+B,CAApD,EAAuD;gBACtD,OAAOU,GAAG,CAACI,IAAX;cACA,CAFD,MAEO,OAAO,0DAAC;gBAAA;kBAAA;oBAAA;sBAAA;wBAAA;wBAAA,OAAkBnB,EAAE,CAACwC,IAAH,CAAQL,eAAR,EAAyBC,IAAzB,EAA+BtB,IAA/B,CAAoC,UAACC,GAAD;0BAAA,OAASA,GAAT;wBAAA,CAApC,CAAlB;;sBAAA;wBAAA;;sBAAA;sBAAA;wBAAA;oBAAA;kBAAA;gBAAA;cAAA,CAAD,IAAP;YACP,CAJK,CAtGa;;UAAA;YA4Gb0B,MA5Ga,GA4GJ,IAAAC,cAAA;cAAA,sEAAM,kBAAOC,GAAP,EAAY5B,GAAZ;gBAAA;;gBAAA;kBAAA;oBAAA;sBAAA;wBAAA;wBAAA,OACE2B,cAAA,CAAME,IAAN,CAAWD,GAAX,CADF;;sBAAA;wBACdE,OADc;wBAEdC,SAFc,GAEFD,OAAO,CAAC1B,IAAR,CAAaE,EAFX;wBAAA;wBAAA,OAKKrB,EAAE,CAACa,GAAH,wBAA4BiC,SAA5B,CALL;;sBAAA;wBAKdC,UALc;wBAMdC,YANc,GAMCD,UAAU,CAAC5B,IANZ;;wBAQpB,IAAI6B,YAAY,CAAC3B,EAAjB,EAAqB;0BACpBjC,UAAU,4BACN4D,YADM;4BAET3B,EAAE,EAAEnC,YAAY,2BAAI8D,YAAJ,aAAIA,YAAJ,uBAAIA,YAAY,CAAE3B,EAAlB,kFAFP;4BAGTE,MAAM,EAAE,IAHC;4BAITC,QAAQ,EAAE,EAJD;4BAKTC,QAAQ,EAAE;8BACTC,IAAI,mBADK;8BAETG,aAAa,EAAE1C,mBAAmB,CAAC6D,YAAD;4BAFzB;0BALD,GAAV;0BAWAnD,OAAO,CAACC,GAAR,CAAYC,oBAAZ,uBAA0CiD,YAAY,CAAC3B,EAAvD;wBACA;;wBAGDN,GAAG,CAACkC,GAAJ,CAAQ,IAAR;;sBAxBoB;sBAAA;wBAAA;oBAAA;kBAAA;gBAAA;cAAA,CAAN;;cAAA;gBAAA;cAAA;YAAA,IA5GI;YAuInBR,MAAM,CAACS,MAAP,CAAc,IAAd,EAAoBrD,OAAO,CAACC,GAAR,CAAYC,oBAAZ,kEAApB;;UAvImB;YAAA;YAAA;;UAAA;YA2IpB,IAAIV,SAAS,IAAI,IAAjB,EAAuB;cACtBO,UAAU,GAAG,IAAIoC,KAAJ,CAAU,sEAAV,CAAb;YACA;;YAGD,IAAI1C,QAAQ,IAAI,IAAhB,EAAsB;cACrBM,UAAU,GAAG,IAAIoC,KAAJ,CAAU,oEAAV,CAAb;YACA;;YAGD,IAAIzC,MAAM,IAAI,IAAd,EAAoB;cACnBK,UAAU,GAAG,IAAIoC,KAAJ,CAAU,kEAAV,CAAb;YACA;;YAGD,IAAIxC,SAAS,IAAI,IAAjB,EAAuB;cACtBI,UAAU,GAAG,IAAIoC,KAAJ,CAAU,qEAAV,CAAb;YACA;;YAGD,IAAIvC,WAAW,IAAI,IAAnB,EAAyB;cACxBG,UAAU,GAAG,IAAIoC,KAAJ,CAAU,uEAAV,CAAb;YACA;;UAjKmB;YAAA,MAoKjBpC,UAAU,KAAK,EApKE;cAAA;cAAA;YAAA;;YAqKduD,WArKc,GAqKA,sCArKA;YAuKpBtD,OAAO,CAACuD,KAAR,CAAcC,iBAAd,EAAsBF,WAAtB;YAvKoB,MAyKdvD,UAzKc;;UAAA;UAAA;YAAA;QAAA;MAAA;IAAA;EAAA,CAAtB;;EAAA;IAAA;EAAA;AAAA;;AA6KAd,OAAO,CAACwE,iBAAR,GAA4B,iBAAa;EAAA,IAAVC,GAAU,SAAVA,GAAU;EACxCA,GAAG,CAACC,GAAJ,CACC,eADD,EAEC,IAAAC,0CAAA,EAAsB;IACrBC,MAAM,yBADe;IAErBC,MAAM,EAAE;EAFa,CAAtB,CAFD;AAOA,CARD"}